# üïµÔ∏è 2.2 Seguridad: Guardi√°n de Privacidad (`pii_guard.py`)

> **Objetivo**: Explicar c√≥mo el sistema limpia datos sensibles (PII) antes de que salgan a Internet.
> **Archivo**: `app/services/pii_guard.py`

---

## Arquitectura de 3 Capas
La funci√≥n principal es `redact_pii_sync`. No es una simple funci√≥n, es un pipeline.

---

## 1. Capa 1: Expresiones Regulares (Rust)
```python
# app/services/pii_guard.py:44
text = fast_regex_scrub(text)
```
*   **Qui√©n**: El m√≥dulo `rust_module` (ver documento 1.2).
*   **Qu√© detecta**: Patrones r√≠gidos.
    *   Emails (`...@gmail.com`)
    *   Tarjetas de Cr√©dito de 16 d√≠gitos.
    *   Direcciones IP.
*   **Coste**: ~0.5ms. (Casi gratis).

---

## 2. Capa 2: Inteligencia Local (ONNX)
```python
# app/services/pii_guard.py:48
engine = get_pii_engine()
return engine.predict(text)
```
*   **Qui√©n**: Un modelo IA peque√±o (`presidio-mini` o similar) corriendo en `ONNX Runtime`.
*   **Qu√© detecta**: Contexto sem√°ntico.
    *   "Mi nombre es **Juan**" (Juan no tiene un patr√≥n regex, necesitas IA para saber que es un nombre).
    *   "Vivo en **Calle Falsa 123**".
*   **Coste**: ~25ms.
*   **Hardware**: Corre en CPU pura. No necesita GPU gracias a la "Cuantizaci√≥n" (INT8).

---

## 3. Capa 3: Cloud Fallback (El Paraca√≠das)
```python
if os.getenv("FORCE_CLOUD_FALLBACK") == "true":
    payload = client.chat.completions.create(...)
```
*   **Funci√≥n**: Si el modo "Paranoico" est√° activo, enviamos el texto a un LLM peque√±o y barato (ej. GPT-3.5-Turbo) con instrucciones espec√≠ficas de limpiar PII.
*   **Riesgo**: Implica enviar datos brutos fuera. Solo se usa como √∫ltimo recurso o para tests de comparaci√≥n.

---

## 4. `PIIEngine` (Clase Singleton)
```python
class PIIEngine:
    _instance = None
```
*   **Patr√≥n Singleton**: Solo cargamos el modelo ONNX **una vez** en memoria.
*   **Por qu√©**: Cargar el modelo toma 2 segundos y consume 200MB de RAM. Si lo hici√©ramos en cada petici√≥n, el servidor se colapsar√≠a. Al usar Singleton, todas las peticiones comparten la misma memoria de modelo (Zero-Copy Read).
