#  2.1 Seguridad: L贸gica de Autenticaci贸n (`logic.py`)

> **Objetivo**: Explicar funci贸n por funci贸n c贸mo identificamos a usuarios y m谩quinas.
> **Archivo**: `app/logic.py`

---

## 1. `create_aut_token`
```python
def create_aut_token(data: dict, expires_delta: Optional[timedelta] = None):
```
**Funci贸n**: Genera el "Pasaporte" interno (JWT).
*   **Por qu茅**: Una vez que un usuario entra (login), no queremos verificar su contrase帽a en cada click. Le damos un token firmado.
*   **Detalle**:
    *   Usa `HS256` (Sim茅trico) porque es m谩s r谩pido que RSA y no necesitamos que nadie fuera del servidor lo verifique.
    *   Inyecta `exp` (Expiraci贸n) autom谩ticamente. Por defecto 15 minutos en producci贸n (seguridad alta).

---

## 2. `verify_api_key`
```python
async def verify_api_key(api_key: str):
```
**Funci贸n**: La puerta blindada para scripts y servidores.
*   **L贸gica Dual**:
    1.  驴Es un JWT? (`eyJ...`): Lo decodifica y extrae el `tenant_id`.
    2.  驴Es una API Key opaca? (`sk_live_...`): No la busca directo en DB.
        *   Calcula `SHA256(key)`.
        *   Busca el hash en Redis (`cache:apikey:...`).
        *   Si no est谩 en Redis, busca en PostgreSQL.
*   **Seguridad**: Nunca tocamos la key real en la base de datos, solo su huella digital (Hash). Si roban la DB, no pueden suplantar a los clientes.

---

## 3. `get_function_config`
```python
async def get_function_config(tenant_id: str, function_id: str):
```
**Funci贸n**: Recupera la "Configuraci贸n Soberana" de una funci贸n espec铆fica.
*   **Prop贸sito**: Un cliente puede tener reglas distintas para "Resumen Legal" (Function A) y "Chatbot Marketing" (Function B).
    *   Esta funci贸n fusiona la configuraci贸n global del tenant con la espec铆fica de la funci贸n ID.

---

## 4. `verify_residency`
```python
def verify_residency(tenant_region: str, server_region: str):
```
**Funci贸n**: El polic铆a de fronteras (GDPR).
*   **L贸gica**:
    *   Si el Tenant es `EU` y el Server es `US` -> **BLOQUEO INMEDIATO**.
    *   Levanta una excepci贸n `451 Unavailable For Legal Reasons`.
    *   Esto garantiza matem谩ticamente que los datos de un cliente europeo nunca se procesen en un servidor americano.
