# 02.4 Zero Trust Identity & Digital Notary (Auditoría Forense)

AgentShield ha evolucionado de un simple proxy seguro a una **Plataforma de Gobierno Corporativo** mediante la implementación de dos pilares fundamentales: **Identidad Zero Trust** y **Notariado Digital**.

## 1. Identity Envelope (Sobre de Identidad)
En lugar de confiar en claves de API estáticas o parámetros en el cuerpo de la petición (`body.user`), AgentShield ahora exige un "Identity Envelope" criptográfico en cada petición.

### Implementación Técnica (`app/services/identity.py`)
- **JWT Bearer Token**: El cliente debe enviar un JSON Web Token firmado en el header `Authorization`.
- **Verificación Criptográfica**: El servidor verifica la firma digital del token usando `ASARL_SECRET_KEY` (HMAC-SHA256).
- **VerifiedIdentity**: Una clase inmutable que encapsula:
    - `tenant_id`: La Organización (Empresa).
    - `dept_id`: El Cost Center (Departamento).
    - `user_id`: El Usuario final.
    - `role`: El nivel de permisos.

> **Zero Trust**: Si el token falta, expira o tiene una firma inválida, la petición es rechazada *antes* de procesar cualquier lógica de negocio.

## 2. Digital Notary (Notario Digital)
Para cumplir con estándares de auditoría bancaria y militar, cada transacción de IA genera un "Recibo Forense" (`Forensic Receipt`). No es solo un log; es evidencia legal.

### Componentes Clave

#### A. Motor de Firma RSA (`app/services/crypto_signer.py`)
Utilizamos criptografía asimétrica (RSA-2048) para firmar digitalmente cada recibo.
- **Clave Privada**: Almacenada de forma segura en el servidor (`certs/private_key.pem`). Se usa para firmar.
- **Clave Pública**: Disponible para auditores externos. Permite verificar la autenticidad sin poder falsificar.

#### B. Hash Chaining (Encadenamiento de Bloques) (`app/services/receipt_manager.py`)
Implementamos una estructura tipo "Blockchain-lite" para garantizar la integridad histórica.
- Cada recibo contiene el campo `previous_hash`, que es el Hash SHA-256 del recibo inmediatamente anterior del mismo Tenant.
- **Inmutabilidad**: Si un administrador de base de datos intenta borrar o modificar un registro intermedio, la cadena de hashes se rompe, alertando de la manipulación.

### Estructura de la Evidencia (`receipts` table)
```json
{
  "receipt_id": "uuid-v4",
  "timestamp": 1705680000,
  "tenant_id": "uuid-empresa",
  "actor": "user@corp.com",
  "previous_hash": "a1b2c3d4...", 
  "model_requested": "gpt-4",
  "model_delivered": "gpt-4-turbo",
  "cost_usd": 0.03,
  "policy_decision": "ALLOW",
  "policy_version_hash": "e5f6g7h8..." // Hash de las reglas vigentes en ese instante
}
```

### Firma Digital
El JSON anterior se canoniza y se firma, produciendo una firma Base64 que se almacena junto al registro. Esto garantiza **No Repudio**: AgentShield certifica que procesó esa petición exacta en ese momento exacto.
