#  3.2 Financiero: Sincronizaci贸n de Precios (`pricing_sync.py`)

> **Objetivo**: Garantizar que nunca cobramos de menos (ni de m谩s). La 煤nica verdad es el precio de mercado actual.
> **Archivo**: `app/services/pricing_sync.py`

---

## El "Protocolo Espejo" (Mirror Protocol)
Los precios de la IA cambian sin aviso. No podemos tenerlos "harcodeados" en el c贸digo. Este m贸dulo, `pricing_sync.py`, conecta AgentShield con el mercado global.

---

## 1. `sync_prices_from_openrouter`
```python
async def sync_prices_from_openrouter():
```
*   **Funci贸n**: Descarga el cat谩logo completo de OpenRouter (cientos de modelos) y lo normaliza.
*   **Frecuencia**: Se ejecuta al arranque (`startup`) y puede ser forzada por el admin.
*   **Persistencia**: Guarda los precios en PostgreSQL (`model_prices`) y actualiza el cach茅 de Redis.
*   **Filtrado**: Solo activamos modelos que tienen un precio > 0 y est谩n disponibles.

---

## 2. `audit_and_correct_price` (Self-Healing)
```python
async def audit_and_correct_price(model, provider, cost_reported_by_provider):
```
*   **Problema**: A veces nuestra base de datos dice que GPT-4 cuesta $30, pero OpenAI baja el precio a $20 hoy.
*   **Soluci贸n**: Despu茅s de cada petici贸n, comparamos el coste calculado por nosotros vs. el reportado por la API del proveedor (LiteLLM obj).
*   **Acci贸n**:
    *   Si hay discrepancia > 5%, confiamos en el proveedor.
    *   Lanzamos una alerta de log.
    *   **Auto-Correcci贸n**: Actualizamos nuestro precio en base de datos para que la pr贸xima vez sea exacto.

---

## 3. Cach茅 de Redis (`price:...`)
Para evitar consultar la base de datos SQL en cada token generado:
*   Guardamos una string simple: `"input_price|output_price"` en la clave `price:{model_name}`.
*   TTL: 24 horas.
*   Esto permite al `Estimator` (ver 3.3) calcular costes en microsegundos.
