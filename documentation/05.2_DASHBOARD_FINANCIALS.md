#  5.2 Dashboard: Finanzas (`dashboard.py`)

> **Objetivo**: Control total sobre d贸nde va el dinero. Facturaci贸n, m谩rgenes y presupuestos.
> **Secci贸n**: Endpoints Financieros

---

## 1. `get_summary`
```python
@router.get("/summary")
```
*   **Funci贸n**: La tarjeta principal del Dashboard ("Gasto vs L铆mite").
*   **Optimizaci贸n**:
    *   Si preguntan por un `cost_center_id` espec铆fico, leemos de Redis (`spend:{tenant}:{cc}`). **Latencia: 1ms**.
    *   Si preguntan GLOBAL, sumamos en PostgreSQL.

## 2. `get_top_spenders` (Top Models)
```python
@router.get("/analytics/top-spenders")
```
*   **Problema**: Calcular esto en Python requerir铆a traer 1 mill贸n de filas y sumarlas. Lento y caro (OOM).
*   **Soluci贸n RPC**: Delegamos el trabajo a la DB con `supabase.rpc("get_top_models_usage")`.
*   PostgreSQL hace la agregaci贸n (`GROUP BY model`) en disco muy eficientemente y solo nos devuelve el JSON final (1 KB).

## 3. `get_profitability_report` (Margin Analysis)
```python
@router.get("/analytics/profitability")
```
*   **M茅trica Clave**: `gross_margin` (Margen Bruto).
*   Calcula la diferencia entre lo que AgentShield paga a OpenAI (`total_cost`) y lo que AgentShield le cobra al cliente final (si aplic贸 un Markup en el Cost Center).
*   Permite a las agencias usar AgentShield como herramienta de re-facturaci贸n.

## 4. `get_spending_history` (Gr谩fico de Barras)
```python
@router.get("/analytics/history")
```
*   De nuevo, usa RPC (`get_daily_spend_history`) para devolver datos agrupados por d铆a (`YYYY-MM-DD`).
*   Esto permite renderizar el gr谩fico sin procesar fechas en el frontend o backend.
