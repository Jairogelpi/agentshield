#  3.3 Financiero: Estimador Multimodal (`estimator.py`)

> **Objetivo**: Predecir el futuro financiero de una petici贸n antes de que ocurra.
> **Archivo**: `app/estimator.py`

---

## Clase `MultimodalEstimator`
No es una simple calculadora. Es un sistema adaptativo.

---

## 1. Ratios de Ca铆da (Fallbacks) Actualizados a 2026
El sistema usa estos valores como "punto de partida" para garantizar la seguridad presupuestaria desde la primera petici贸n.

| Categor铆a | Ratio | Justificaci贸n T茅cnica 2026 |
| :--- | :---: | :--- |
| **DEEP_REASONING** | `12.0` | Cr铆tico para modelos o1/o3/R1. El "pensamiento" genera miles de tokens invisibles. |
| **CREATIVE_WRITING** | `4.5` | Los modelos modernos son extremadamente verbosos en tareas literarias. |
| **CODE_GENERATION** | `3.8` | Incluye l贸gica, comentarios, tests y boilerplate preventivo. |
| **TEXT_TRANSLATION**| `1.35`| La expansi贸n hacia idiomas romances (ES/FR/IT) es de aprox. +35%. |
| **TEXT_EXTRACTION** | `0.45` | El peso de las estructuras JSON/Markdown invalida el viejo ratio 0.1. |
| **CHAT_CONVERSATIONAL**| `1.6`| Incluye la oratoria y cortes铆a caracter铆stica de los LLMs modernos. |

---

## 2. El Ciclo de Vida: De Fallback a Realidad
La funci贸n `learn_from_reality` inyecta la "verdad" del mercado en el sistema despu茅s de cada ejecuci贸n:

1.  **Captura Real**: Se calcula el ratio exacto: `output_tokens / input_tokens`.
2.  **Suavizado EMA (Alpha = 0.1)**: Evita que peticiones an贸malas (errores o respuestas inusualmente largas) descalibren el sistema.
3.  **Persistencia en Redis**: Los ratios aprendidos se guardan por **30 d铆as**, permitiendo que AgentShield "conozca" el comportamiento espec铆fico de cada modelo y cliente.

---

## 3. Implementaci贸n Financiera
Al llamar a `estimate_cost`, el sistema protege el margen de beneficio aplicando:
```python
est_output_tokens = int(input_unit_count * ratio)
total_cost_usd = (input_unit_count * price_in) + (est_output_tokens * price_out)
```
Esta precisi贸n convierte a AgentShield en una herramienta de **grado financiero**, no solo t茅cnico.

---

## 4. `_resolve_price` (Fallback en Cascada)
1.  **LiteLLM SDK**: Fuente primaria de precios internos.
2.  **Redis Cache**: Acceso r谩pido a precios sincronizados.
3.  **Supabase DB**: Tabla maestra de precios (`model_prices`).
4.  **$0.00**: Safe-fallback (con alerta de sistema).
