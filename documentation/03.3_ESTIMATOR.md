# 游늵 3.3 Financiero: Estimador Multimodal (`estimator.py`)

> **Objetivo**: Predecir el futuro financiero de una petici칩n antes de que ocurra.
> **Archivo**: `app/estimator.py`

---

## Clase `MultimodalEstimator`
No es una simple calculadora. Es un sistema adaptativo.

---

## 1. El Problema del Output Desconocido
Cuando un usuario env칤a 100 tokens ("Escribe un ensayo"), no sabemos si la IA responder치 100 tokens (corto) o 1000 tokens (largo). El coste var칤a 10x.

### Soluci칩n: Ratios Din치micos (`_get_dynamic_ratio`)
```python
async def _get_dynamic_ratio(self, task_type, model):
```
*   El sistema consulta Redis para ver el historial: "Para tareas de `CREATIVE_WRITING` con `GPT-4`, por cada token que entra, suelen salir 2.5 tokens".
*   Si no hay datos hist칩ricos, usa `self.fallback_ratios` (hardcodeados por seguridad).

---

## 2. `learn_from_reality` (EMA Learning)
```python
async def learn_from_reality(self, task_type, model, input, output):
```
*   Despu칠s de cada petici칩n real, ajustamos nuestro conocimiento.
*   **Matem치tica (EMA)**: `NuevoRatio = (Realidad * 0.1) + (Memoria * 0.9)`.
*   Esto hace que el sistema aprenda tendencias sin volverse loco por una sola petici칩n an칩mala.

---

## 3. `estimate_cost` (La API P칰blica)
```python
async def estimate_cost(self, model, task_type, input_unit_count, metadata):
```
Soporta m칰ltiples modalidades:
*   **Texto**: Usa `(Input * PriceIn) + (Input * Ratio * PriceOut)`.
*   **Imagen**: Detecta resoluci칩n (`hd` vs `standard`) en metadata y busca el precio por unidad (item).
    *   *Detalle*: Si el modelo es `dall-e-3`, busca el precio de `dall-e-3-hd` si el usuario pidi칩 alta calidad.

---

## 4. `_resolve_price` (Fallback en Cascada)
1.  **LiteLLM SDK**: Pregunta a la librer칤a si conoce el precio.
2.  **Redis Cache**: Si no, mira nuestro cach칠 r치pido.
3.  **Supabase DB**: Si no, busca en la tabla maestra.
4.  **$0.00**: Si nadie sabe nada, asume gratis (pero loguea error).
