# 游 4.3 Proxy: Rate Limiter (`limiter.py`)

> **Objetivo**: Proteger la infraestructura de ataques DDoS y "Vecinos Ruidosos".
> **Archivo**: `app/limiter.py`

---

## 1. `get_real_ip_address`
```python
def get_real_ip_address(request: Request):
```
*   **Problema**: En producci칩n, AgentShield est치 detr치s de Cloudflare y el Balanceador de Carga de Render. `request.client.host` siempre ser칤a la IP local del balanceador.
*   **Soluci칩n**: Leemos cabeceras est치ndar de la industria:
    1.  `CF-Connecting-IP` (Cloudflare).
    2.  `X-Forwarded-For` (Proxies est치ndar).

---

## 2. `get_tenant_rate_limit_key` (Smart Key)
```python
def get_tenant_rate_limit_key(request: Request):
```
*   **Estrategia**: No limitamos por IP (porque una oficina entera puede compartir una IP). Limitamos por **Identidad**.
    1.  Si hay `Authorization: Bearer <token>`, usamos el hash del token.
    2.  Si hay `X-Function-ID`, usamos la ID de la funci칩n.
    3.  Solo si es an칩nimo, usamos la IP.
*   Esto permite que un cliente Enterprise lance 1000 DPS (RPS) desde una sola IP sin ser bloqueado, mientras bloqueamos a un hacker en esa misma IP.

---

## 3. Integraci칩n `slowapi`
```python
limiter = Limiter(key_func=get_tenant_rate_limit_key, storage_uri=redis_url)
```
*   Usamos **Redis** como backend de almacenamiento (Token Bucket).
*   Esto permite que el l칤mite se comparta entre m칰ltiples r칠plicas (workers) de AgentShield. Si tienes 10 servidores, el l칤mite es global, no por servidor.
