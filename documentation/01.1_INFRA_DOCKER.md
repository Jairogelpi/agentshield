# 游냡 1.1 Infraestructura: An치lisis del Dockerfile

> **Objetivo**: Explicar l칤nea por l칤nea c칩mo construimos una imagen de producci칩n capaz de correr en 2GB de RAM.
> **Archivo**: `Dockerfile`

---

## Estrategia General: Multi-Stage Build
No usamos una sola imagen. Usamos dos:
1.  **Builder (La F치brica)**: Una imagen pesada (1GB+) con compiladores (GCC, Rust, Cargo) para construir las dependencias.
2.  **Runner (El Producto)**: Una imagen ligera (150MB) que solo tiene lo necesario para ejecutar. No tiene compiladores.

---

## An치lisis L칤nea por L칤nea

### Etapa 1: Builder
```dockerfile
# 4: Usamos Python 3.13 Slim como base. Versi칩n 'slim' es Debian sin basura gr치fica.
FROM python:3.13-slim AS builder

# 7-11: Instalamos Rust.
# 쯇or qu칠? Porque 'tokenizers' y nuestro m칩dulo 'rust_module' necesitan compilar c칩digo nativo.
# Si no instalamos 'build-essential', pip fallar칤a al instalar librer칤as complejas.
RUN apt-get update && apt-get install ... rustup ...
```

### Gesti칩n de Paquetes: `uv` (La revoluci칩n)
```dockerfile
# 14-15: Copiamos 'uv' desde su imagen oficial.
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv
```
> **Decisi칩n T칠cnica**: 쯇or qu칠 `uv` en vez de `pip`?
> *   **Pros**: `uv` es 10-100x m치s r치pido resolviendo dependencias. Reduce el tiempo de deploy de 5 mins a 30 segs.
> *   **Contras**: Es una tecnolog칤a muy nueva (2024), pero estable.

### Compilaci칩n del N칰cleo Rust
```dockerfile
# 20-23: Compilamos 'rust_module'
COPY rust_module /app/rust_module
RUN maturin build --release --strip
```
> **Nota**: Usamos `maturin`, que es el puente est치ndar entre Rust y Python. La flag `--strip` elimina s칤mbolos de depuraci칩n para ahorrar espacio.

### Pre-Carga de Modelos (El Secreto del "Zero Cold Start")
```dockerfile
# 38: Descarga del modelo de Embeddings
python -c "from flashrank import Ranker; Ranker(model_name='ms-marco-MiniLM-L-12-v2', cache_dir='/app/model_cache')"
```
> **Crucial**: Normalmente, las apps de IA descargan modelos al arrancar (`runtime`). Esto es peligroso porque:
> 1. Si HuggingFace se cae, tu app no arranca.
> 2. Tu app tarda 2 minutos en responder la primera petici칩n.
> **Soluci칩n**: Nosotros lo descargamos durante el `docker build`. As칤, la imagen final ya tiene el modelo "quemado" en disco.

---

### Etapa 2: Runner (Producci칩n)
```dockerfile
# 41: Empezamos desde cero con una imagen limpia.
FROM python:3.13-slim

# 50: TRANSFORMERS_OFFLINE=1
```
> **Seguridad**: Esta variable de entorno PROH칈BE a la librer칤a `transformers` conectarse a internet. Si intenta descargar algo, fallar치. Esto garantiza que el servidor es **herm칠tico**.

### Servidor Web: Granian
```dockerfile
# 73: CMD ["sh", "-c", "granian ... --workers 1"]
```
> **Decisi칩n**: Usamos `Granian` (escrito en Rust) en lugar de `Uvicorn` o `Gunicorn`.
> *   **Motivo**: Maneja mejor la concurrencia en entornos de **1 sola CPU** al liberar el GIL de Python m치s eficientemente en operaciones I/O.
