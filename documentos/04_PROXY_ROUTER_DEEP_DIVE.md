# üöÄ El Motor Central: Proxy Router (God Tier Architecture)

Este no es un simple "pasarela" de datos. `proxy.py` es el **Coraz√≥n Operativo** y el **Motor de Valor** de AgentShield. Es el lugar donde la seguridad, el ahorro y la experiencia de usuario convergen en milisegundos. 

Su dise√±o es "God Tier" porque resuelve el problema m√°s dif√≠cil de la IA corporativa: **¬øC√≥mo dar libertad al usuario sin perder el control del presupuesto y la seguridad?**

---

## üíé ¬øPor qu√© esta arquitectura es la mejor posible?

### 1. El Oleoducto de Decisiones (Modular Pipeline)
A diferencia de otros proxies que son un bloque de c√≥digo gigante y dif√≠cil de cambiar, el Proxy de AgentShield usa un **Decision Pipeline**.
*   **La Raz√≥n Estrat√©gica:** Permite a√±adir nuevas capas de seguridad (ej. detecci√≥n de alucinaciones o filtros de sesgo) en el futuro sin romper el sistema de chat. Es una arquitectura **"Future-Proof"**.
*   **Valor:** Agilidad total. Podemos adaptar el comportamiento de la IA a nuevas leyes o pol√≠ticas de empresa en minutos.

### 2. Memoria Colmena Evolutiva (Evolutionary Hive Mind)
No es un simple "cach√©". Es un sistema de **aprendizaje din√°mico y federado**.
*   **La Raz√≥n Estrat√©gica:** Si varios empleados resuelven problemas relacionados, AgentShield **sintetiza** ese conocimiento. El siguiente empleado obtendr√° una respuesta enriquecida por la sabidur√≠a colectiva de la empresa.
*   **Valor:** Transforma el gasto recurrente en un **activo de conocimiento inmutable**. Cuanto m√°s se usa AgentShield, m√°s inteligente y barato se vuelve.

### 3. Gobernanza de Agentes (2-Man Rule Tooling)
AgentShield es el primer proxy que entiende lo que los agentes intentan hacer **antes** de que lo hagan.
*   **La Raz√≥n Estrat√©gica:** Interceptamos los `tool_calls`. Si un agente intenta una acci√≥n sensible, detenemos el flujo y solicitamos aprobaci√≥n.
*   **Valor:** Elimina el riesgo de "Shadow AI Agents" actuando por su cuenta. Es el control total sobre la autonom√≠a.

### 4. Seguridad de Salida Din√°mica (Real-time Safety)
No esperamos a que termine el mensaje. Escaneamos cada chunk de datos.
*   **La Raz√≥n Estrat√©gica:** Si detectamos un Jailbreak o una filtraci√≥n de PII corporativa en la respuesta de la IA, el **Kill-Switch** corta la conexi√≥n al instante.
*   **Valor:** Protecci√≥n total contra robo de datos y manipulaci√≥n de modelos.

### 5. El HUD: Transparencia y Ahorro Real
Ya no son estimaciones; es realidad financiera.
*   **La Raz√≥n Estrat√©gica:** Usamos `tiktoken` y sincronizaci√≥n directa con `litellm` para calcular costes y ahorros con c√©ntimos de d√≥lar de precisi√≥n. El HUD muestra la **Soberan√≠a de Datos** (Regi√≥n) y el estado de gobernanza.
*   **Valor:** Justifica el Retorno de Inversi√≥n (ROI) en cada token.

---

## üõ†Ô∏è Anatom√≠a de una Transacci√≥n "Elite"

El c√≥digo en `proxy.py` sigue un flujo de tres fases Zenith:

1.  **Fase de Pre-Vuelo:** Validaci√≥n de identidad, presupuesto y riesgo v√≠a Pipeline modular.
2.  **Streaming con Procesamiento Activo:**
    - **Buffered Tools:** Acumulaci√≥n y revisi√≥n de llamadas a funciones.
    - **Safety Scan:** Revisi√≥n proactiva de contenido.
    - **Mid-stream Kill:** Corte por presupuesto o seguridad.
3.  **Cierre Inmutable:** Generaci√≥n de recibo firmado, actualizaci√≥n de SIEM federado y persistencia en Memoria Colmena.

---

## üìà Impacto Directo en el Negocio

*   **Gobernanza Total:** Controla no solo lo que la IA dice, sino lo que la IA **hace**.
*   **Ahorro Exponencial:** La Memoria Colmena reduce el CAPEX de IA a medida que la organizaci√≥n aprende.
*   **Compliance 2026:** Preparado para Auditor√≠as Forenses y Soberan√≠a de Datos.

---

## üöÄ Pr√≥ximo Nivel: Hacia el 100% de Perfecci√≥n
Para llevar este archivo al nivel absoluto de excelencia:
*   **Estimaci√≥n Predictiva Eficiente:** Usar el `estimator.py` para que el HUD sea preciso incluso antes de que la IA empiece a escribir (dar feedback instant√°neo de coste).
*   **M√∫ltiples Nodos de Hive:** Sincronizar la memoria entre diferentes regiones del mundo para empresas globales.

**AgentShield Proxy es la infraestructura definitiva para la era de la IA Aut√≥noma y Segura.**
